name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

jobs:
  review-pr:
    # Only review PRs from feature/* or bugfix/* branches
    if: |
      startsWith(github.head_ref, 'feature/') ||
      startsWith(github.head_ref, 'bugfix/')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Get changed files
        id: files
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)
          {
            echo "files<<EOF"
            echo "$FILES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude PR Review
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PR_TITLE='${{ github.event.pull_request.title }}'
          PR_BODY='${{ github.event.pull_request.body }}'
          CHANGED_FILES='${{ steps.files.outputs.files }}'

          PROMPT="You are a code reviewer. Review this Pull Request thoroughly.

          ## PR Information
          - Title: ${PR_TITLE}
          - Description: ${PR_BODY}
          - Source Branch: ${{ github.head_ref }}
          - Target Branch: ${{ github.base_ref }}

          ## Changed Files
          ${CHANGED_FILES}

          ## Review Format
          Provide your review with these sections:

          ### Summary
          Brief overview (2-3 sentences)

          ### Changes Analysis
          What changed and why it matters

          ### Code Quality
          Bugs, style issues, edge cases

          ### Security Considerations
          Any security implications

          ### Recommendations
          Improvements and questions

          ### Verdict
          APPROVE, REQUEST_CHANGES, or COMMENT with justification

          Be constructive and specific."

          OUTPUT=$(claude --print --dangerously-skip-permissions "$PROMPT" 2>&1) || true

          {
            echo "review<<REVIEW_EOF_MARKER"
            echo "$OUTPUT"
            echo "REVIEW_EOF_MARKER"
          } >> $GITHUB_OUTPUT

      - name: Post Review Comment
        uses: actions/github-script@v7
        env:
          REVIEW_OUTPUT: ${{ steps.review.outputs.review }}
        with:
          script: |
            const review = process.env.REVIEW_OUTPUT || 'Review completed.';
            const action = context.payload.action === 'synchronize' ? 'updated' : 'opened';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## Claude Code Review\n\n${review}\n\n---\n*Automated review triggered on PR ${action}*`
            });
